<!DOCTYPE html>
<html>
<head>
    <title>Mini Discord Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2f3136; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; top:0; left:0; width: 100%; height: 100%; background: #36393f; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #2f3136; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 320px; text-align: center; }
        
        /* Sidebar */
        #sidebar { width: 240px; background: #202225; display: flex; flex-direction: column; padding: 15px; border-right: 1px solid #18191c; }
        .server-btn { padding: 12px; margin: 5px 0; background: #36393f; border-radius: 5px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .server-btn:hover { background: #4f545c; }
        .active { background: #5865f2 !important; color: white; }

        /* Chat Area */
        #main-chat { flex: 1; display: flex; flex-direction: column; background: #36393f; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; }
        .message { background: #40444b; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid transparent; }
        .role-tag { font-size: 0.65em; padding: 2px 6px; border-radius: 4px; background: #202225; margin-right: 8px; font-weight: bold; vertical-align: middle; }

        /* Controls */
        #input-area { background: #40444b; padding: 20px; display: flex; gap: 10px; align-items: center; }
        input, select { padding: 12px; border-radius: 5px; border: none; background: #202225; color: white; outline: none; }
        #messageInput { flex: 1; }
        .admin-only { display: none; }
        button { padding: 12px 20px; border: none; border-radius: 5px; background: #5865f2; color: white; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">Mini Discord</h2>
            <input id="login-username" placeholder="Username" style="width: 100%; margin-bottom: 10px;">
            <input id="admin-pass" type="password" placeholder="Admin Password (Optional)" style="width: 100%; margin-bottom: 20px;">
            <button onclick="login()" style="width: 100%;">Join Server</button>
        </div>
    </div>

    <div id="sidebar">
        <h3 style="margin-top: 0;">Servers</h3>
        <div class="server-btn active" onclick="switchServer('General', this)"># general</div>
        <div class="server-btn" onclick="switchServer('Gaming', this)"># gaming</div>
        <div class="server-btn" onclick="switchServer('Dev', this)"># development</div>
        
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #4f545c;">
            <button id="admin-btn" class="admin-only" onclick="createNewRole()" style="background: #3ba55d; width: 100%;">+ Create New Role</button>
            <button onclick="logout()" style="background: #ed4245; width: 100%; margin-top: 10px;">Logout</button>
        </div>
    </div>

    <div id="main-chat">
        <div id="chat-container"></div>
        <div id="input-area">
            <select id="userRole">
                <option value="Member">Member</option>
                </select>
            <input id="messageInput" placeholder="Message..." autocomplete="off">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = "General";
        let session = JSON.parse(localStorage.getItem('chat-session'));

        // 1. Session & Login Logic
        if (session) {
            document.getElementById('login-overlay').classList.add('hidden');
            if (session.role === 'Admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }
        }

        function login() {
            const user = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('admin-pass').value;
            let role = "Member";
            let color = "#ffffff";

            if (!user) return alert("Please enter a username");

            // CHANGE "1234" TO YOUR SECRET PASSWORD
            if (pass === "1234") {
                role = "Admin";
                color = "#ed4245"; // Admin Red
            }

            session = { user, role, color };
            localStorage.setItem('chat-session', JSON.stringify(session));
            location.reload();
        }

        function logout() {
            localStorage.removeItem('chat-session');
            location.reload();
        }

        // 2. Room & Role Logic
        function switchServer(room, el) {
            currentRoom = room;
            document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('chat-container').innerHTML = '';
            socket.emit('join room', room);
        }

        socket.emit('join room', 'General');

        function createNewRole() {
            const name = prompt("New Role Name:");
            const color = prompt("Role Color (Hex Code, e.g. #00ff00):", "#ffffff");
            if (name) {
                socket.emit("create role", { name, color });
            }
        }

        // 3. Socket Listeners
        socket.on('load history', (history, customRoles) => {
            const roleSelect = document.getElementById('userRole');
            
            // Clear and reload roles in dropdown
            roleSelect.innerHTML = '<option value="Member">Member</option>';
            if (session.role === 'Admin') roleSelect.innerHTML += '<option value="Admin">Admin</option>';
            
            customRoles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.name;
                opt.text = r.name;
                roleSelect.add(opt);
            });

            history.forEach(renderMessage);
        });

        socket.on('role created', (role) => {
            const opt = document.createElement('option');
            opt.value = role.name;
            opt.text = role.name;
            document.getElementById('userRole').add(opt);
            alert(`A new role was added: ${role.name}`);
        });

        socket.on('chat message', renderMessage);

        // 4. Messaging Functions
        function renderMessage(data) {
            const div = document.createElement('div');
            div.className = 'message';
            div.style.borderLeftColor = data.color || '#5865f2';
            div.innerHTML = `
                <span class="role-tag" style="color:${data.color}">${data.role}</span>
                <b style="color:${data.color}">${data.user}</b> 
                <small style="color:#72767d; margin-left:10px;">${data.time || ''}</small>
                <div style="margin-top:5px;">${data.text}</div>
            `;
            const container = document.getElementById('chat-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            const role = document.getElementById('userRole').value;
            if (text && session) {
                socket.emit('chat message', { 
                    user: session.user, 
                    text, 
                    role: role, 
                    color: session.color, 
                    room: currentRoom 
                });
                document.getElementById('messageInput').value = '';
            }
        }

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>